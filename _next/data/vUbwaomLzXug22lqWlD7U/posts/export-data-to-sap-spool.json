{"pageProps":{"post":{"title":"Экспорт данных из SAP Query-отчета во внутреннюю таблицу через SPOOL","date":"2021-03-20T08:40:14.217Z","slug":"export-data-to-sap-spool","author":{"name":"Roman A. Nosov","picture":"https://avatars3.githubusercontent.com/u/21103635?s=120&v=4","url":"https://github.com/JustAddAcid"},"content":"<p>Господа, м'сье абапье и прочие любители подглядывать за страданиями! Представляю вашему вниманию очередной результат танцев с бубенцами. Который в этот раз будет чуть менее бесполезным. И (быть может) сэкономит время какому-нибудь заблудившемуся <strong>SAP</strong>-кодерасту.</p>\n<p>Иногда хочется выть от боли, когда в очередной раз появляются требования выгрузки данных из стандартных или квази-стандартных отчетов SAP. Которые зачастую вообще не предусматривают какой-либо экспорт или расширение.</p>\n<p>Дальше будет <strong>ABAP</strong> и рассказывания о подноготной <strong>SAP ERP</strong>. Если у вас нет вуайеристских наклонностей или профессионального интереса в дальнейшем тексте, то рекомендую закрыть страницу, чтобы не испытать экзистенциальный ужас от полученной информации.</p>\n<p>Что ж, погружаемся, товарищи. Так сказать, пристегните ремни. Будет немного трясти <del>и пованивать</del>.</p>\n<p><img src=\"../assets/blog/export-data-to-sap-spool/dipping.jpg\" alt=\"Погружаемся!\"></p>\n<h2>Поехали.</h2>\n<p>Итак, представим ситуацию: Вы сидите, неспешно ковыряете код. И тут прилетает задача —  достать данные из древнего отчета, нарисованного в <strong>SAP Query</strong> через <strong>Report painter</strong>; их немного обработать и отдать в другой интерфейс.</p>\n<p>Казалось бы, что может быть сложного? Ну, например, всё. </p>\n<h3>SAP Query (далее SQ)</h3>\n<p>Это сраный <strong>SAP Query</strong>. Пользователь мышой натыкивает нужные ему поля и форму отчета, а на выходе получает готовый отчет. Софтина сама собирает ABAP-программу по конфигу. Класна? Нет. </p>\n<p>Каждая дальнейшаая правка отчета в пользовательской морде пересобирает целиком <em>всё</em>. Более того, никто не гарантирует, что программа пересоберется с тем же техническим названием. Ну и при переезде правок по ландшафту дев-тест-прод -> будет генерироваться разное название.</p>\n<p><strong>Вывод:</strong> Вписаться в код отчета и вытащить данные перед их отображением —  не получится. Юзверь перезатрёт всё прямзавтра. А скорее всего —  вчера.</p>\n<p><img src=\"../assets/blog/export-data-to-sap-spool/userflow.jpg\" alt=\"userflow\"></p>\n<h3>Report Painter</h3>\n<p>Я нарвался на <em>\"не совсем классическое\"</em>  использование <strong>SQ</strong>! Данные выводятся не напрямую, а проходят через <em>\"прослойку отрисовщика\"</em> (Report Painter). И воспользоваться стандартным FM <strong>RSAQ_REMOTE_QUERY_CALL</strong>, увы, не выйдет. </p>\n<p>Т.к. для заданного отчета вообще нет таких параметров, как <em>\"имя запроса\"</em> и  <em>\"группа пользователей\"</em>. Просто н<strong>е</strong>чего подавать в аргументы функции.</p>\n<p><strong>Вывод:</strong> Увы, воспользоваться предусмотренными FM невозможно. </p>\n<h3>Это, мать вашу, не ALV</h3>\n<p>А жаль. При отображении, ALV-таблицы постят свои мета-(и не очень мета)данные в глобальный скоуп сессии пользователя. И оттуда элементарно вытащить что угодно. Например, вот так:</p>\n<pre><code class=\"language-abap\">cl_salv_bs_runtime_info=>set( EXPORTING display  = abap_false  \n                                        metadata = abap_true  \n                                        data     = abap_true ).\n                                        \n\" submit report and return\n\ncl_salv_bs_runtime_info=>get_data_ref( IMPORTING r_data = ro_data ).\n\n\" do with ro_data what you want\n</code></pre>\n<h3>Но выход всгда есть</h3>\n<p><em>(особенно, если вы живёте достаточно высоко)</em></p>\n<p>Давайте подумаем, <strong>что может общего</strong> между матричными принтерами, и решением моей задачи? </p>\n<p><img src=\"../assets/blog/export-data-to-sap-spool/printer.jpeg\" alt=\"printer\"></p>\n<p>Да, теми самыми принтерами с рулоном ленты. Которые буквально печатают \"стуча\" по бумаге, как старые печатающие машинки. И которые могут использовать только <em>ASCII</em> символы. </p>\n<p><strong>А то</strong>, что <strong>SAP</strong> <em>(Эдакая древняя громадина)</em> из коробки поддерживает <em>ASCII</em>-фикацию и печать всех отчетов, которые отрисовываются \"стандартным\" способом. Так это же то, что мне нужно! Такой текст будет элементарно распарсить после получения.</p>\n<p>Достаточно дёрнуть печать отчета, и вовремя подхватить <em>ASCII</em>-фицированный документ кодом! Получается что-то вроде этого:</p>\n<p>Создаём фоновое задание, где будет выполняться рендеринг и попытка печати.</p>\n<pre><code class=\"language-abap\">CALL FUNCTION 'JOB_OPEN'\n  EXPORTING\n    jobname          = kv_job_name\n  IMPORTING\n    jobcount         = lv_jobcount.\n</code></pre>\n<p>Собираем параметры печати. Нам нужно попросить программу напечататься сразу же после выполнения, и не показывать никаких диалогов. </p>\n<pre><code class=\"language-abap\">CALL FUNCTION 'GET_PRINT_PARAMETERS'\n  EXPORTING\n    list_name      = 'TEST'\n    list_text      = 'SUBMIT this fucking program TO SAP-SPOOL'\n    immediately    = abap_true\n    no_dialog      = abap_true\n  IMPORTING\n    out_parameters = ls_params\n    valid          = lv_valid.\n</code></pre>\n<p>Вызываем программу в фоне со всеми собранными параметрами. Конструкция <strong>to sap-spool ... without spool</strong> нисколько сап не смущает. И вполне корректно отрабатывает. </p>\n<pre><code class=\"language-abap\">SUBMIT program_technical_name USING SELECTION-SET 'VAR1' \n      TO SAP-SPOOL SPOOL PARAMETERS ls_params \n      WITHOUT SPOOL DYNPRO \n      VIA JOB kv_job_name NUMBER lv_jobcount \n      AND RETURN.\n</code></pre>\n<p>Так, программу мы вызвали, теперь придется костылём дожидаться завершения фоновой задачи. Никаких ивентов и коллбэков тут нет. </p>\n<pre><code class=\"language-abap\">\" Костыль ожидания завершения асинхронной жобы\nWHILE ls_empty IS INITIAL.\n  WAIT UP TO 5 SECONDS.\n  SELECT SINGLE * FROM tbtco INTO ls_empty WHERE jobname = kv_job_name AND jobcount = lv_jobcount AND status = 'F'.\nENDWHILE.\n</code></pre>\n<p>Ну, собственно, всё. Фоновая задача завершена. В системе уже хранятся отрендеренные данные, и нам остаётся лишь их подхватить. </p>\n<pre><code class=\"language-abap\">SELECT SINGLE listident\n  FROM tbtcp\n  INTO lv_listident\n  WHERE jobname = kv_job_name\n    AND jobcount = lv_jobcount.\n \nCHECK lv_listident IS NOT INITIAL.\n \nlv_rqident = lv_listident.\n \nCALL FUNCTION 'RSPO_RETURN_ABAP_SPOOLJOB'\n  EXPORTING\n    rqident              = lv_rqident\n  TABLES\n    buffer               = lt_buffer.\n</code></pre>\n<p>В результате получаем внутрённюю таблицу <strong>lt_buffer</strong> из строк отчета. Её элементарно разбирать на куски, и вытаскивать нужные нам значения.</p>\n<p>Столбцы в такой таблице разделены символом вертикальной черты '|' и ничего не стоит распарсить поля по отдельности. </p>\n<p>Полный код на github gists: <a href=\"https://gist.github.com/JustAddAcid/450d4cd5f1069dbac61c3e842508b969\">https://gist.github.com/JustAddAcid/450d4cd5f1069dbac61c3e842508b969</a></p>\n<iframe frameborder=\"0\" style=\"border:none;width:100%;height:180px;\" width=\"100%\" height=\"180\" src=\"https://music.yandex.ru/iframe/#track/57987781/8763763\">Слушайте <a href='https://music.yandex.ru/album/8763763/track/57987781'>What the Fuck</a> — <a href='https://music.yandex.ru/artist/7756103'>RHODAMINE</a> на Яндекс.Музыке</iframe>\n","ogImage":{"url":"/assets/blog/export-data-to-sap-spool/background.jpg"},"coverImage":"/assets/blog/export-data-to-sap-spool/background.jpg","issueId":"18"}},"__N_SSG":true}